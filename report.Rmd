---
title: "Performance analysis"
author: ""
output:
  pdf_document:
    fig_crop: no
    fig_height: 14
    fig_width: 14
    toc: yes
    toc_depth: 3
params:
  file1: ""
  file2: ""
  file3: ""

---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library("data.table")
library("stringr")
library("ggplot2")
library("grid")
library("scales")
library("pander")
library("XML")

data2sum <- function( data ) {

  s1 <- data[, list( "mean", round( mean(util), digits = 2 ),
                             round( mean(iops), digits = 2 ),
                             round( mean(riops), digits = 2 ),
                             round( mean(wiops), digits = 2 ),
                             round( mean(bw), digits = 2 ),
                             round( mean(rbw), digits = 2 ),
                             round( mean(wbw), digits = 2 ),
                             round( mean(rsize), digits = 2 ),
                             round( mean(wsize), digits = 2 ),
                             round( mean(rt), digits = 2 ),
                             round( mean(st), digits = 2 ),
                             round( mean(ql), digits = 2 )
                     ), by = list( object, name, owner ) ]
 
  s2 <- data[, list( "95th", round( quantile( util, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( iops, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( riops, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( wiops, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( bw, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( rbw, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( wbw, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( rsize, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( wsize, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( rt, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( st, c(0.95), na.rm = TRUE ), digits = 2 ),
                             round( quantile( ql, c(0.95), na.rm = TRUE ), digits = 2 )
                     ), by = list( object, name, owner ) ]

  s3 <- data[, list( "max", round( max(util), digits = 2 ),
                            round( max(iops), digits = 2 ),
                            round( max(riops), digits = 2 ),
                            round( max(wiops), digits = 2 ),
                            round( max(bw), digits = 2 ),
                            round( max(rbw), digits = 2 ),
                            round( max(wbw), digits = 2 ),
                            round( max(rsize), digits = 2 ),
                            round( max(wsize), digits = 2 ),
                            round( max(rt), digits = 2 ),
                            round( max(st), digits = 2 ),
                            round( max(ql), digits = 2 )
                     ), by = list( object, name, owner ) ]

  sum <- rbind( s1, s2, s3 )
  setnames( sum, c( "object", "name", "owner", "stat", "util", "iops", "riops", "wiops", "bw", "rbw", "wbw", "rsize", "wsize", "rt", "st", "ql" ) )

  return( sum )
}

data2type <- function( data ) {

  tt <- data[, list( object, date, name, owner, iops, bw ) ]
  tt$size <- 0
  tt$type <- "total"

  rt <- data[, list( object, date, name, owner, riops, rbw, rsize ) ]
  setnames( rt, c( "object", "date", "name", "owner", "iops", "bw", "size" ) )
  rt$type <- "read"

  wt <- data[, list( object, date, name, owner, wiops, wbw, wsize ) ]
  setnames( wt, c( "object", "date", "name", "owner", "iops", "bw", "size" ) )
  wt$type <- "write"

  nt <- rbind( tt, rt, wt )

  return( nt )
}

 
data.file <- params$file1
config.file <- params$file2
rel.file <- params$file3


rawdata <- read.csv( data.file, stringsAsFactor = FALSE )
config.doc <- xmlParse(config.file)
rel.doc <- xmlParse(rel.file)
array.name <- xpathSApply( config.doc, "//object[@type='Subsystem']//value[@type='Name']", xmlValue )
array.sn <- xpathSApply( config.doc, "//object[@type='Subsystem']//value[@type='Array Serial Number']", xmlValue )
rawdata <- rawdata[ rawdata$Owner.Array.Name == array.name, ]

data <- data.table( object = rawdata$Object.Name,
                    date = as.POSIXct( strptime( rawdata$Poll.Time,"%m/%d/%Y %H:%M:%S" ) ),
                    owner = rawdata$Current.Owner,
                    util = rawdata$Utilization...,
                    iops = rawdata$Total.Throughput..IO.s.,
                    riops = rawdata$Read.Throughput..IO.s.,
                    wiops = rawdata$Write.Throughput..IO.s.,
                    bw = rawdata$Total.Bandwidth..MB.s.,
                    rbw = rawdata$Read.Bandwidth..MB.s.,
                    wbw = rawdata$Write.Bandwidth..MB.s.,
                    rsize = rawdata$Read.Size..KB.,
                    wsize = rawdata$Write.Size..KB.,
                    rt = rawdata$Response.Time..ms,
                    st = rawdata$Service.Time..ms,
                    ql = rawdata$Queue.Length )
```

\newpage

## Summary

Performance analysis of the array **`r array.name`**, S/N: **`r array.sn`**

Data taken from **`r head( rawdata$Poll.Time, 1 )`** to **`r tail( rawdata$Poll.Time, 1 )`**

## Controllers

```{r echo = FALSE, message = FALSE, warning = FALSE }
sp.data <- data[ object == "SP A" | object == "SP B", ]
sp.data$name <- sp.data$object
sp.plus <- sp.data[, list( mean(util), sum(iops), sum(riops), sum(wiops), sum(bw), sum(rbw), sum(wbw), mean(rsize), mean(wsize), mean(rt), mean(st), mean(ql) ), by = list( date ) ]
setnames( sp.plus, c( "date", "util", "iops", "riops", "wiops", "bw", "rbw", "wbw", "rsize", "wsize", "rt", "st", "ql") )
sp.plus$object <- "SPA+SPB"
sp.plus$name <- "SPA+SPB"
sp.plus$owner <- ""
sp.plus <- rbind( sp.data, sp.plus )
sp.sum <- data2sum( sp.plus )
sp.type <- data2type( sp.data )
```

### Summary of controllers performance

The list of controllers stats of IOPS, bandwidth, utilization and read and write size.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
sp.sum <- sp.sum[ order( sp.sum$object, decreasing = FALSE ), ]
pandoc.table( as.data.frame( sp.sum[, list( object, stat, util, iops, bw, rsize, wsize ) ] ),
              caption = "Summary of Controllers performance",
              justify = c( 'left', 'left', 'right', 'right', 'right', 'right', 'right' )
            )
```

\newpage

### Controllers utilization

Plot of utilization of both controllers with 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = sp.data, aes( x = date, y = util, colour = object ) ) +
  geom_line() + xlab("") + ylab( "Utilization %" ) +
  ggtitle( "Utilization on SPA and SPB with 95th percentile" ) + 
  geom_line( y = quantile( sp.data[ object == "SP A", ]$util, c(0.95) ),
             colour = "#FF6666", size = 1 ) + 
  geom_line( y = quantile( sp.data[ object == "SP B", ]$util, c(0.95) ),
             colour = "cyan3", size = 1 ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```

\newpage

### Controllers IOPS

Plot of total throughput on both controllers with 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = sp.type[ type == "total", ], aes( x = date, y = iops ) ) +
  geom_area ( aes( colour = object, fill = object ), position = 'stack' ) +
  xlab("") + ylab( "IOPS" ) +
  ggtitle( "Total Throughput on SPA and SPB with 95th percentile" ) +
  geom_line( y = quantile( sp.type[ type == "total" & object == "SP A", ]$iops, c(0.95) ),
             colour = "#FF6666", size = 1 ) +
  geom_line( y = quantile( sp.type[ type == "total" & object == "SP B", ]$iops, c(0.95) ),
             colour = "cyan3", size = 1 ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```


Plot of read and write throughput on both controllers.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = sp.type, aes( x = date, y = iops, colour = type ) ) +
  geom_line() + xlab("") + ylab( "IOPS" ) +
  ggtitle( "Total, Read and Write Throughput on both SP" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  scale_color_manual( values = c( "#FF6666", "black", "cyan3" ) ) +
  facet_grid( object ~ . ) + theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```

\newpage

### Controllers Bandwidth

Plot of total bandwidth on both controllers with 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = sp.type[ type == "total", ], aes( x = date, y = bw ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack' ) +
  xlab("") + ylab( "MB/s" ) +
  ggtitle( "Total Bandwidth on SPA and SPB with 95th percentile" ) +
  geom_line( y = quantile( sp.type[ type == "total" & object == "SP A", ]$bw, c(0.95) ),
             colour = "#FF6666", size = 1 ) +
  geom_line( y = quantile( sp.type[ type == "total" & object == "SP B", ]$bw, c(0.95) ),
             colour = "cyan3", size = 1 ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```


Plot of read and write bandwidth on both controllers.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = sp.type, aes( x = date, y = bw, colour = type ) ) +
  geom_line() + xlab("") + ylab( "MB/s" ) + 
  ggtitle( "Total, Read and Write Bandwidth on both SP" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  scale_color_manual( values = c( "#FF6666", "black", "cyan3" ) ) + 
  facet_grid( object ~ . ) + theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```

\newpage

### Controllers Read and Write Size

Histogram of read and write sizes on both controllers.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = sp.type[ type == "read" | type == "write", ], 
        aes( x = size, colour = type, fill = type ) ) +
  geom_histogram( binwidth = 8 ) + facet_grid( ~ object ) +
  ggtitle( "Read and Write Size on both SP" ) + xlab( "Size, KB" ) + ylab("")
```


Plot of read and write sizes on both controllers.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = sp.type[ type == "read" | type == "write" ],
        aes( x = date, y = size, colour = type ) ) +
  geom_line() + xlab("") + ylab( "Size, KB" ) + 
  ggtitle( "Read and Write Size on both SP" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( object ~ ., scales = "free" ) +
  theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```

\newpage

## Front-end

```{r echo = FALSE, message = FALSE, warning = FALSE }
port.data <- data[ grepl( "Port ([0-9]+)", object ), ]
port.data$wwn = str_replace_all( port.data$object, "Port ([0-9]+) \\[FC; ([0-9A-F:]+) \\]", "\\2" )
spaports <- xpathSApply( rel.doc, "//object[@name='SP A']/object[@type='Port']", xmlAttrs )[2,]
spbports <- xpathSApply( rel.doc, "//object[@name='SP B']/object[@type='Port']", xmlAttrs )[2,]
ports <- rbindlist( list(
           data.table(
             name = str_replace_all( spaports, "Port ([0-9]+) \\[FC; ([0-9A-F:]+) \\]", "A\\1" ),
             wwn = str_replace_all( spaports, "Port ([0-9]+) \\[FC; ([0-9A-F:]+) \\]", "\\2" )
           ),
           data.table(
             name = str_replace_all( spbports, "Port ([0-9]+) \\[FC; ([0-9A-F:]+) \\]", "B\\1" ),
             wwn = str_replace_all( spbports, "Port ([0-9]+) \\[FC; ([0-9A-F:]+) \\]", "\\2" )
           )
         ))
port.data <- merge( port.data, ports, by='wwn', all = TRUE )
port.data$object <- port.data$name
port.data[ grepl( "A([0-9]+)", object), ]$owner <- "SPA"
port.data[ grepl( "B([0-9]+)", object), ]$owner <- "SPB"
port.sum <- data2sum( port.data )
port.type <- data2type( port.data )
port.type$object <- str_replace_all( port.type$object, "([AB])([0-9]+)", "\\2")
```

### Summary of front-end ports performance

The list of front-end ports stats of IOPS, bandwidth and read and write size.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
port.sum <- port.sum[ order( port.sum$object, decreasing = FALSE ), ]
pandoc.table( as.data.frame( port.sum[, list( object, stat, iops, bw, rsize, wsize ) ] ),
              caption = "Summary of front-end ports performance",
              justify = c( 'left', 'left', 'right', 'right', 'right', 'right' )
            )
```

\newpage

### Front-end ports IOPS

Plot of total throughput on front-end ports.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = port.type[ type == "total", ], aes( x = date, y = iops ) ) +
  geom_area ( aes( colour = object, fill = object ), position = 'stack' ) +
  xlab("") + ylab( "IOPS" ) +
  ggtitle( "Total Throughput on front-end ports" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) ) + facet_grid( . ~ owner )
```


Plot of read and write throughput on front-end ports.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = port.type, aes( x = date, y = iops, colour = type ) ) +
  geom_line() + xlab("") + ylab( "IOPS" ) +
  ggtitle( "Total, Read and Write Throughput on front-end ports" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  scale_color_manual( values = c( "#FF6666", "black", "cyan3" ) ) +
  facet_grid( object ~ owner ) + theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```

\newpage

### Front-end ports Bandwidth

Plot of total bandwidth on front-end ports.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = port.type[ type == "total", ], aes( x = date, y = bw ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack' ) +
  xlab("") + ylab( "MB/s" ) +
  ggtitle( "Total Bandwidth on front-end port" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) ) + facet_grid( . ~ owner )
```


Plot of read and write bandwidth on front-end ports.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = port.type, aes( x = date, y = bw, colour = type ) ) +
  geom_line() + xlab("") + ylab( "MB/s" ) + 
  ggtitle( "Total, Read and Write Bandwidth on front-end port" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  scale_color_manual( values = c( "#FF6666", "black", "cyan3" ) ) + 
  facet_grid( object ~ owner ) + theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```

\newpage

### Front-end ports Read and Write Size

Histogram of read and write sizes on front-end ports.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = port.type[ type == "read" | type == "write", ], 
        aes( x = size, colour = type, fill = type ) ) +
  geom_histogram( binwidth = 8 ) + facet_grid( owner ~ object ) +
  ggtitle( "Read and Write Size on front-end ports" ) + xlab( "Size, KB" ) + ylab("")
```


Plot of read and write sizes on front-end ports.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = port.type[ type == "read" | type == "write" ],
        aes( x = date, y = size, colour = type ) ) +
  geom_line() + xlab("") + ylab( "Size, KB" ) + 
  ggtitle( "Read and Write Size on front-end ports" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( object ~ owner, scales = "free" ) +
  theme( legend.title = element_blank(), strip.text.y = element_text(angle = 0) )
```

\newpage

## Pools, RAID Groups and LUNs

```{r echo = FALSE, message = FALSE, warning = FALSE }
lun.data <- data[ grepl( "([[:print:]]+) \\[([0-9]+);", object ), ]
lun.data$name <- str_replace_all( lun.data$object, "([[:print:]]+) \\[([0-9]+)([[:print:]]+)","\\1" )
lun.data$object <- str_replace_all( lun.data$object, "([[:print:]]+) \\[([0-9]+)([[:print:]]+)","\\2" )
lun.data$sp <- paste( "SP", lun.data$owner, sep = "" )

lun.owners <- rbindlist( lapply( c(
  xpathSApply( rel.doc, "//object[@type='RAID Group']", xmlGetAttr, 'name' ),
  xpathSApply( rel.doc, "//object[@type='Pool']", xmlGetAttr, 'name' ) ),
  function(x) data.table( lun = xpathSApply( rel.doc,
                                             paste("//object[@name='",x,"']/object[@type='Pool Public LUN' or
                                                   @type='Public RaidGroup LUN' or
                                                   @type='Private RaidGroup LUN']",
                                                   sep=""),
                                             xmlGetAttr, 'name' ),
                          owner = x )
))

lun.owners$name <- str_replace_all( lun.owners$lun, "([[:print:]]+) \\[([0-9]+)([[:print:]]+)","\\1" )
lun.owners$object <- str_replace_all( lun.owners$lun, "([[:print:]]+) \\[([0-9]+)([[:print:]]+)","\\2" )
lun.owners$owner <- str_replace_all( lun.owners$owner, "(Raid Group) ([0-9]+)", "RG \\2" )

lun.data <- merge( lun.data, lun.owners, by='object', all = TRUE )
lun.data$owner <- lun.data$owner.y
lun.data$name <- lun.data$name.y
lun.data$owner.x <- NULL
lun.data$owner.y <- NULL
lun.data$name.x <- NULL
lun.data$name.y <- NULL
lun.data <- lun.data[ !is.na(date), ]

lun.sum <- data2sum( lun.data )
lun.type <- data2type( lun.data )

pools.data <- lun.data[, list( mean(util), sum(iops), sum(riops), sum(wiops),
                               sum(bw), sum(rbw), sum(wbw), mean(rsize), mean(wsize),
                               mean(rt), mean(st), mean(ql) ), by = list( owner, date ) ]
setnames( pools.data, c( "object", "date", "util", "iops", "riops", "wiops",
                         "bw", "rbw", "wbw", "rsize", "wsize", "rt", "st", "ql") )
pools.data$name <- pools.data$object
pools.data$owner <- ""
pools.sum <- data2sum( pools.data )
pools.type <- data2type( pools.data )
```

### Summary of Pools and RAID Groups performance

The list of all Pools and RAID Groups with 95th percentile of IOPS, bandwidth, utilization, response time, queue length and %IOPS, sorted by IOPS.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
ps <- pools.sum[ stat == "95th", ]
ps <- ps[ order( ps$iops, decreasing = TRUE ), ]
ps.sum <- sum(ps$iops)
ps$piops <- round((ps$iops/ps.sum)*100,2)
pandoc.table( as.data.frame( ps[, list( name, iops, bw, util, rt, ql, piops ) ] ),
              caption = "Summary LUNs performance",
              justify = c( 'left', 'right', 'right', 'right', 'right', 'right', 'right' )
            )
```

### Summary of LUNs performance

The list of all LUNs with 95th percentile of IOPS, bandwidth, utilization, response time and queue length, sorted by IOPS.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
ls <- lun.sum[ stat == "95th", ]
ls <- ls[ order( ls$iops, decreasing = TRUE ), ]
pandoc.table( as.data.frame( ls[, list( object, name, owner, iops, bw, util, rt, ql ) ] ),
              caption = "Summary LUNs performance",
              justify = c( 'left', 'left', 'left', 'right', 'right', 'right', 'right', 'right' )
            )
```

\newpage

### LUNs IOPS

Histogram of total throughput by 95th percentile of all LUNs.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = ls, aes( 1 : dim(ls)[1], iops ) ) +
  geom_bar( stat = "identity", aes( fill = owner ) ) +
  ylab( "IOPS" ) + xlab( "LUNs" ) + 
  ggtitle( "Total IOPS on all LUNs by 95th percentile" ) +
  geom_line( aes( y = ( cumsum( ls$iops ) * max( ls$iops ) ) / max( cumsum( ls$iops ) ) ) ) +
  scale_x_discrete( limits = c( 1 : dim(ls)[1]),
                    label = function(x) { paste( ls$object, ": ", ls[ x, ]$name ) } ) +
  theme( axis.text.x = element_text( angle = 90, size = rel(0.3) ), legend.title = element_blank() )
```


Plot of total throughput of all LUNs.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = lun.type[ type == "total", ], aes( x = date, y = iops, colour = object ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack') +
  xlab("") + ylab( "IOPS" ) + ggtitle( "Total Throughput of all LUNs" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ ., scales = "free"  ) + 
  theme( legend.position = "none", strip.text.y = element_text(angle = 0) )
```


Plot of read and write throughput of all LUNs.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = lun.type[ type == "read" | type == "write", ],
        aes( x = date, y = iops, colour = object ) ) +
  geom_line() + xlab("") + ylab( "IOPS" ) +
  ggtitle( "Read and Write Throughput of all LUNs" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) + 
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### LUNs Bandwidth

Plot of total bandwidth of all LUNs in MB/s.

```{r echo = FALSE, message = FALSE, warning = FALSE}
ggplot( data = lun.type[ type == "total", ], aes( x = date, y = bw, colour = object ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack') +
  xlab("") + ylab( "MB/s" ) + ggtitle( "Total Bandwidth of all LUNs" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ ., scales = "free" ) + 
  theme( legend.position = "none", strip.text.y = element_text(angle = 0) )
```


Plot of read and write bandwidth of all LUNs.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = lun.type[ type == "read" | type == "write", ],
        aes( x = date, y = bw, colour = object ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack') + xlab("") +
  ylab( "MB/s" ) + ggtitle( "Read and Write Bandwidth of all LUNs on SP A and SP B" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) + 
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### LUNs Read and Write Size

The list of LUNs stats of read and write sizes.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
lun.sum <- lun.sum[ order( as.numeric(lun.sum$object), decreasing = FALSE ), ]
pandoc.table( as.data.frame( lun.sum[ stat == "95th", list( object, name, owner, rsize, wsize ) ] ),
              caption="LUNs Read/Write Size by 95th percentile",
              justify = c( 'left', 'left', 'left', 'right', 'right' )
            )
```


Plot of read and write sizes of all LUNs.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = lun.type[ type == "read" | type == "write" ],
        aes( x = date, y = size, colour = object ) ) +
  geom_line() + xlab("") + ylab( "Size, KB" ) +
  ggtitle( "Read and Write Size of all LUNs on both SP" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) +
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### LUNs performance classification

Relation of response time to throughput by queue length and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = lun.sum[ stat == "95th", ], aes( iops, rt, label = object ) ) + 
  geom_point( aes( size = ql, colour = util ) ) + 
  geom_text( hjust = -0.2, vjust = -0.6, size = 3 ) +
  xlab( "IOPS" ) + ylab( "Response Time" ) +
  ggtitle( "LUNs: Response Time vs IOPS by QL and Utilization" ) + 
  scale_color_gradient( low = "green", high = "red" ) + facet_grid( owner ~ ., scales = "free" )
```


Relation of bandwidth to throughput to by response time and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = lun.sum[ stat == "95th", ], aes( iops, bw, label = object ) ) + 
  geom_point( aes( size = rt, colour = util ) ) +
  geom_text( hjust = -0.5, vjust = -0.5, size = 3 ) + xlab( "IOPS" ) + ylab( "MB/s" ) + 
  ggtitle( "LUNs: Bandwidth vs IOPS by Response Time and Utilization" ) +
  scale_color_gradient( low = "green", high = "red" ) + facet_grid( owner ~ ., scales = "free" )
```


Realtion of write throughput to read throughput by response time and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = lun.sum[ stat == "95th", ], aes( riops, wiops, label = object )) +
  geom_point( aes( colour = util, size = rt ) ) +
  geom_text( hjust = -0.5, vjust = -0.5, size = 3 ) + 
  xlab( "Read IOPS" ) + ylab( "Write IOPS" ) + 
  ggtitle( "Write IOPS vs Read IOPS by Utilization and Response Time" ) + 
  scale_color_gradient( low = "green", high = "red" ) + facet_grid( owner ~ ., scales = "free" )
```

\newpage

## Disks

```{r echo = FALSE, message = FALSE, warning = FALSE }
disk.data <- data[ grepl( "Bus [0-9]", object ), ]
disk.data$name <- disk.data$object
disk.data$bus <- str_replace_all( disk.data$name,
                                    "Bus ([0-9]) Enclosure ([0-9]) Disk ([0-9]+)",
                                    "\\1" )
disk.data$object <- str_replace_all( disk.data$name,
                                    "Bus ([0-9]) Enclosure ([0-9]) Disk ([0-9]+)",
                                    "\\1_\\2_\\3" )

disk.config <- as.data.table( cbind(
                 xpathSApply( config.doc, "//object[@type='Disk']//value[@type='Name']", xmlValue ),
                 xpathSApply( config.doc, "//object[@type='Disk']//value[@type='Drive Type']", xmlValue )
               ))
names(disk.config) <- c("name","type")
disk.config$object <- str_replace_all( disk.config$name, "Bus ([0-9]) Enclosure ([0-9]) Disk ([0-9]+)", "\\1_\\2_\\3" )

disk.owners <- rbindlist( lapply( c(
              xpathSApply( rel.doc, "//object[@type='RAID Group']",xmlGetAttr,'name' ),
              xpathSApply( rel.doc, "//object[@type='Pool']",xmlGetAttr,'name' ) ),
              function(x) data.table( disk = xpathSApply( rel.doc,
                                                          paste("//object[@name='",x,"']/object[@type='Disk']", sep=""),
                                                          xmlGetAttr, 'name' ),
                                      owner = x )
            ))

disk.owners$name <- disk.owners$disk
disk.owners$object <- str_replace_all( disk.owners$name, "Bus ([0-9]) Enclosure ([0-9]) Disk ([0-9]+)", "\\1_\\2_\\3" )
disk.owners$owner <- str_replace_all( disk.owners$owner, "(Raid Group) ([0-9]+)", "RG \\2" )

disk.co <- merge( disk.config, disk.owners, by = "object", all = TRUE )
disk.co$name.x <- NULL
disk.co$name.y <-NULL
disk.co$disk <- NULL

disk.data <- merge( disk.data, disk.co, by = "object", all = TRUE )
disk.data$owner <- disk.data$owner.y
disk.data$owner.x <- NULL
disk.data$owner.y <- NULL

disk.data$name <- disk.data$type
disk.sum <- data2sum( disk.data )

disk.data$owner <- disk.data$bus
disk.type <- data2type( disk.data )
```

### Summary of disks performance

The summary of all disks types with 95th percentile of IOPS, bandwidth, utilization, service time, queue length and % IOPS, sorted by IOPS.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
dbytype <- disk.data[, list( mean(util), sum(iops), sum(riops), sum(wiops), sum(bw), sum(rbw), sum(wbw), mean(rsize),
                             mean(wsize), mean(rt), mean(st), mean(ql) ), by = list( type, date ) ]
setnames( dbytype, c( "object", "date", "util", "iops", "riops", "wiops", "bw", "rbw", "wbw", "rsize", "wsize",
                      "rt", "st", "ql") )
dbytype$owner <- ""
dbytype$name <- dbytype$object
dbytype.sum <- data2sum( dbytype )
dts <- dbytype.sum[ stat == "95th", ]
dts <- dts[ order( dts$iops, decreasing = TRUE ), ]
dts.sum <- sum(dts$iops)
dts$piops <- round( (dts$iops/dts.sum)*100, 2 )
pandoc.table( as.data.frame( dts[, list( name, iops, util, bw, st, ql, piops ) ]),
              caption = "Summary Disks performance",
              justify = c( 'left', 'right', 'right', 'right', 'right', 'right', 'right' ) )
```

The list of all disks with 95th percentile of IOPS, bandwidth, utilization, service time and queue length, sorted by IOPS.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
ds <- disk.sum[ stat == "95th", ]
ds <- ds[ order( ds$iops, decreasing = TRUE ), ]
ds$type <- ds$name
pandoc.table( as.data.frame( ds[, list( object, type, owner, iops, util, bw, st, ql ) ]),
              caption = "Summary Disks performance",
              justify = c( 'left', 'left', 'left', 'right', 'right', 'right', 'right', 'right' ) )
```

\newpage

### Disks Heatmap

```{r echo = FALSE, message = FALSE, warning = FALSE }
dhm <- disk.sum[ stat == "95th", .( object, owner, util ) ]
dhm$dae <- str_replace_all( dhm$object, "([0-9]+)_([0-9]+)_([0-9]+)", "\\1_\\2" )
dhm$disk <- as.numeric( str_replace_all( dhm$object, "([0-9]+)_([0-9]+)_([0-9]+)", "\\3" ) )
dhm[ is.na(dhm$owner), ]$owner <- ""

ggplot( dhm, aes( disk, dae ) ) + geom_tile( aes( fill = util ), colour = "black" ) +
  scale_fill_gradient( low = "green", high = "red", limits=c( 0, 100 ) ) + 
  xlab( "Disk" ) + ylab( "DAE" ) +
  ggtitle( "Disks Utilization Hetamap by 95th percentile" ) +
  scale_x_discrete( limits = c( 0 : max( dhm$disk ) ) ) +
  theme_classic() + theme( legend.title = element_blank() ) + geom_text( aes( label = owner ), size = 2.8 )
```

\newpage

### Disks IOPS

Plot of total throughput of all disks by buses.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = disk.type[ type == "total", ], aes( x = date, y = iops, colour = object ) ) +
  geom_line() + xlab("") + ylab( "IOPS" ) +
  ggtitle( "Total Throughput of all Disks by Buses" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ ., scales = "free" ) +
  theme( legend.position = "none", strip.text.y = element_text(angle = 0) )
```


Plot of read and write throughput of all disks by buses.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = disk.type[ type == "read" | type == "write", ],
        aes( x = date, y = iops, colour = object ) ) + geom_line() +
  xlab("") + ylab( "IOPS" ) + 
  ggtitle( "Read and Write Throughput of all Disks by Buses" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) + 
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### Disks Bandwidth

Plot of total bandwidth of all disks on both controllers in MB/s.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = disk.type[ type == "total", ], aes( x = date, y = bw ) ) +
  geom_area( aes( colour = object ), position = 'stack') +
  xlab("") + ylab( "MB/s" ) + ggtitle( "Total Bandwidth of all Disks by Buses" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ ., scales = "free" ) +
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```


Plot of read and write bandwidth of all disks by buses.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = disk.type[ type == "read" | type == "write", ],
        aes( x = date, y = bw, colour = object ) ) +
  geom_line() +
  xlab("") + ylab( "MB/s" ) +
  ggtitle( "Read and Write Bandwidth of all Disks by Buses" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) + 
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### Disks performance classification

Relation of utiliztion to throughput by queue length and service time by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = disk.sum[ stat == "95th", ], aes( iops, util, label = object ) ) +
  geom_point( aes( size = st, colour = ql ) ) +
  geom_text( hjust = -0.2, vjust = -0.2, size = 3 ) +
  xlab( "IOPS" ) + ylab( "Utilization" ) + 
  ggtitle( "Disks: Utilization vs IOPS by Service Time and QL" ) +
  scale_color_gradient( low = "green", high = "red" ) + facet_grid( . ~ name, scales = "free" )
```


Relation of bandwidth to throughput to by service time and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = disk.sum[ stat == "95th", ], aes( iops, bw, label = object ) ) + 
  geom_point( aes( size = st, colour = util ) ) +
  geom_text( hjust = -0.5, vjust = -0.5, size = 3 ) + xlab( "IOPS" ) + ylab( "MB/s" ) + 
  ggtitle( "LUNs: Bandwidth vs IOPS by Service Time and Utilization" ) +
  scale_color_gradient( low = "green", high = "red" ) + facet_grid( . ~ name, scales = "free" )
```


Realtion of write throughput to read throughput by service time and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = disk.sum[ stat == "95th", ], aes( riops, wiops, label = object )) +
  geom_point( aes( colour = util, size = st ) ) +
  geom_text( hjust = -0.5, vjust = -0.5, size = 3) + 
  xlab( "Read IOPS" ) + ylab( "Write IOPS" ) + 
  ggtitle( "Write IOPS vs Read IOPS by Utilization and Service Time" ) + 
  scale_color_gradient( low = "green", high = "red" ) + facet_grid( . ~ name, scales = "free" )
```

\newpage

## Hosts

Information about host's workload was extracted from LUN data.

```{r echo = FALSE, message = FALSE, warning = FALSE }
lun.hosts <- rbindlist( lapply( c(
               xpathSApply( rel.doc, "//object[@type='SP']//object[@type='Public RaidGroup LUN']", xmlGetAttr, 'name' ),
               xpathSApply( rel.doc, "//object[@type='SP']//object[@type='Pool Public LUN']", xmlGetAttr, 'name' )),
               function(x) data.table(
                 lun = x,
                 host = xpathSApply( rel.doc,
                                     paste( "//object[@type='SP']//object[@name='",x,"']/object[@type='Host']", sep="" ),
                                     xmlGetAttr, 'name' )
               )
             ))
lun.hosts <- lun.hosts[ host != 'NULL', ]
lun.hosts$lun.name <- str_replace_all( lun.hosts$lun, "([[:print:]]+) \\[([0-9]+)([[:print:]]+)","\\1" )
lun.hosts$lun <- str_replace_all( lun.hosts$lun, "([[:print:]]+) \\[([0-9]+)([[:print:]]+)","\\2" )
lun.hosts$host <- unlist(lun.hosts$host)
setnames(lun.hosts, c("lun", "host", "name"))

lun.pools <- lun.owners
lun.pools$lun <- NULL
setnames(lun.pools,c("pool","name","lun"))

lun.pool.host <- merge( lun.pools, lun.hosts, by=c('lun','name'), all = FALSE )
```

The list of hosts and connected to them LUNs.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
for (x in levels(as.factor(lun.pool.host$host)))  {
  print(x)
  lh <- lun.pool.host[ host == x, ]
  lh$lun <- as.integer(lh$lun)
  pandoc.table( lh[ order(lh$lun), .(lun, name, pool) ])
}
```

```{r echo = FALSE, message = FALSE, warning = FALSE }
host.data <- data[ grepl( "([[:print:]]+) \\[([0-9]+);", object ), ]
host.data$lun <-  str_replace_all( host.data$object,
                                 "([[:print:]]+) \\[([0-9]+); ([[:print:]]+)","\\2" )
host.data$lun.name <- str_replace_all( host.data$object,
                                    "([[:print:]]+) \\[([0-9]+); ([[:print:]]+)","\\1" )
host.data$object <- str_replace_all( host.data$object,
                                     "([[:print:]]+) \\[([0-9]+); ([[:print:]]+)\\]",
                                     "\\3" )
host.data$object <- str_replace_all( host.data$object,"RAID ([0-9_]+)", "" )
host.data$object <- str_replace_all( host.data$object,"^; ", "" )
host.data <- host.data[ object != "", ]
host.data$owner <- host.data$object
host.data$object <- host.data$lun
host.data$name <- host.data$lun.name
host.data$lun <- NULL
host.data$lun.name <- NULL

host.sum <- data2sum( host.data )
host.type <- data2type( host.data )
```

\newpage

### Summary of hosts performance

The list of all hosts with 95th percentile of IOPS, bandwidth, utilization, response time and queue length, sorted by IOPS.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
hds <- host.data[, list( mean(util), sum(iops), sum(riops), sum(wiops),
                         sum(bw), sum(rbw), sum(wbw), mean(rsize), mean(wsize),
                         mean(rt), mean(st), mean(ql) ), by = list( owner, date ) ]
setnames( hds, c( "object", "date", "util", "iops", "riops", "wiops",
                  "bw", "rbw", "wbw", "rsize", "wsize", "rt", "st", "ql") )
hds$name <- hds$object
hds$owner <- ""
hds.sum <- data2sum( hds )

hs <- hds.sum[ stat == "95th", ]
hs <- hs[ order( hs$iops, decreasing = TRUE ), ]
pandoc.table( as.data.frame( hs[, list( object, iops, bw, util, rt, ql ) ] ),
              caption = "Summary hosts performance",
              justify = c( 'left', 'right', 'right', 'right', 'right', 'right' )
            )
```

\newpage

### Hosts IOPS

Histogram of total throughput by 95th percentile of all hosts.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = hs, aes( 1 : dim(hs)[1], iops ) ) +
  geom_bar( stat = "identity", fill="blue" ) +
  ylab( "IOPS" ) + xlab( "" ) + 
  ggtitle( "Total IOPS on all hosts by 95th percentile" ) +
  geom_line( aes( y = ( cumsum( hs$iops ) * max( hs$iops ) ) / max( cumsum( hs$iops ) ) ) ) +
  scale_x_discrete( limits = c( 1 : dim(hs)[1]), label = hs$object ) +
  theme( axis.text.x = element_text( angle = 90, size = 10, face="bold" ), legend.title = element_blank() )
```


Plot of total throughput of all hosts.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = host.type[ type == "total", ], aes( x = date, y = iops, colour = object ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack') +
  xlab("") + ylab( "IOPS" ) + ggtitle( "Total Throughput of all hosts" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ ., scales = "free"  ) + 
  theme( legend.position = "none", strip.text.y = element_text(angle = 0) )
```


Plot of read and write throughput of all hosts.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = host.type[ type == "read" | type == "write", ],
        aes( x = date, y = iops, colour = object ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack') +
  xlab("") + ylab( "IOPS" ) + ggtitle( "Read and Write Throughput of all hosts" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) + 
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### Host Bandwidth

Plot of total throughput of all hosts.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = host.type[ type == "total", ], aes( x = date, y = bw, colour = object ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack') +
  xlab("") + ylab( "MB/s" ) + ggtitle( "Total Bandwidth of all hosts" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ ., scales = "free" ) + 
  theme( legend.position = "none", strip.text.y = element_text(angle = 0) )
```


Plot of read and write bandwidth of all hosts.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = host.type[ type == "read" | type == "write", ],
        aes( x = date, y = bw, colour = object ) ) +
  geom_area( aes( colour = object, fill = object ), position = 'stack') + xlab("") +
  ylab( "MB/s" ) + ggtitle( "Read and Write Bandwidth of all hosts" ) + 
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) + 
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### Hosts Read and Write Size

The list of hosts stats of read and write sizes.

```{r echo = FALSE, message = FALSE, results = 'asis', warning = FALSE }
hds.sum <- hds.sum[ order( host.sum$object, decreasing = FALSE ), ]
pandoc.table( as.data.frame( hds.sum[ stat == "95th", list( object, rsize, wsize ) ] ),
              caption="LUNs Read/Write Size by 95th percentile",
              justify = c( 'left', 'right', 'right' )
            )
```

Plot of read and write sizes of all hosts.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = host.type[ type == "read" | type == "write" ],
        aes( x = date, y = size, colour = object ) ) +
  geom_line() + xlab("") + ylab( "Size, KB" ) +
  ggtitle( "Read and Write Size of all LUNs on both SP" ) +
  scale_x_datetime( labels = date_format( "%m/%d %H:%m" ) ) +
  facet_grid( owner ~ type, scales = "free" ) +
  theme( axis.text.x = element_text( angle = 90 ), legend.position = "none", strip.text.y = element_text(angle = 0) )
```

\newpage

### Hosts performance classification

Relation of response time to throughput by queue length and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = hds.sum[ stat == "95th", ], aes( iops, rt, label = object ) ) + 
  geom_point( aes( size = ql, colour = util ) ) + 
  geom_text( hjust = -0.1, vjust = -0.1, size = 3 ) +
  xlab( "IOPS" ) + ylab( "Response Time" ) +
  ggtitle( "Hosts: Response Time vs IOPS by QL and Utilization" ) + 
  scale_color_gradient( low = "green", high = "red" )
```


Relation of bandwidth to throughput to by response time and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = hds.sum[ stat == "95th", ], aes( iops, bw, label = object ) ) + 
  geom_point( aes( size = rt, colour = util ) ) +
  geom_text( hjust = -0.1, vjust = -0.1, size = 3 ) + xlab( "IOPS" ) + ylab( "MB/s" ) + 
  ggtitle( "Hosts: Bandwidth vs IOPS by Response Time and Utilization" ) +
  scale_color_gradient( low = "green", high = "red" )
```


Realtion of write throughput to read throughput by response time and utilization by 95th percentile.

```{r echo = FALSE, message = FALSE, warning = FALSE }
ggplot( data = hds.sum[ stat == "95th", ], aes( riops, wiops, label = object )) +
  geom_point( aes( colour = util, size = rt ) ) +
  geom_text( hjust = -0.1, vjust = -0.1, size = 3 ) + 
  xlab( "Read IOPS" ) + ylab( "Write IOPS" ) + 
  ggtitle( "Hosts: Write IOPS vs Read IOPS by Utilization and Response Time" ) + 
  scale_color_gradient( low = "green", high = "red" )
```
